# 预决算报告智能生成系统（区级 SaaS）PRD v1.0（原型冻结版）

> 范围说明：一期只做**预算**；二期扩展**决算**（已预留口子与数据模型）。  
> 口径：同时支持**单位口径**与**部门口径**。  
> 数据来源：填报端上传区预决算一体化平台导出的 Excel（单文件），示例为《002002-上海市普陀区民政局-人代会报表制作.xlsx》。  
> 输出：PDF 为主（像素级一致），同时可导出“填充后 Excel”。  
> 校验：容差统一 0.01 万元；存在 Fatal 时**禁止生成**。  
> 纠错策略（已确认）：**上年决算纠错建议采用 B 模式**——单位可先提交“建议值”并用于本次报告生成；管理员只审核“是否入库（更新历史归档）”，不审核“本次报告是否可用”。

---

## 1. 背景与目标

### 1.1 背景
区财政统一推进预决算公开。单位/部门从区一体化平台导出预算 Excel，在编制公开报告过程中易出现：
- 表内/表间勾稽不一致（合计/明细、收入与支出、拨款与支出等）
- 上下年数据不对称（上年执行数/决算数引用错误或缺失）
- 文字说明与表格数字不一致（编制说明、财政拨款支出主要内容逐条列示等）
- 政府采购、绩效、资产等平台表中天然缺失，需要人工补录

### 1.2 总体目标
1) **自动生成公开报告**：单位上传 Excel → 系统解析/入库 → 按模板生成报告（PDF/Excel）。  
2) **前置校验与纠错**：生成前自动校验并定位问题，降低后续复核工作量。  
3) **沉淀可分析的数据资产**：上传数据、解析字段、校验结果、最终报告版本均入库，为后续数据分析系统铺路。  
4) **区级统一模板与规则**：模板由内部维护（上海市统一模板为主），系统仅“填值与校验”，不随意改版式。

---

## 2. 分期范围

### 2.1 一期（预算）——必须交付
- 支持两类输入：
  - **单位口径**（样例：002002-…-人代会报表制作.xlsx，18 张表）
  - **部门口径**（样例：上海市普陀区民政局.xlsx、万里街道办事处.xlsx，21 张表）
- 解析与入库：上传 Excel → 解析 sheets/cells → facts（预算事实）→ draft（报告草稿）→ version（报告版本）
- 校验（含容差 0.01 万元）与禁止生成（Fatal gating）
- “财政拨款支出主要内容”逐条列示原因填报（条目多、可检索、可过滤、可整节预览）
- 平台缺失字段的人工补录：政府采购、绩效、资产等
- 输出：像素级一致 PDF + 填充后 Excel
- 后台维护（最小可用）：
  1) 组织目录（部门树 + 单位列表）  
  2) 基础信息库（主要职能/机构设置/名词解释）版本化维护  
  3) 历史决算归档（用于“上年执行数/决算数”来源）导入/锁定/纠错建议入库审核  
  4) 模板与规则维护（版本、映射、Fatal 清单、容差、原因必填阈值）  
  5) 审计日志（关键动作留痕）

### 2.2 二期（决算）——预留口子，后续交付
- 决算输入 Excel 解析（决算表体系）
- 预算 vs 决算对比（执行进度/差异原因）
- 决算公开报告模板渲染（像素级一致）
- 更完整的数据分析指标体系（跨年、跨部门、跨单位）
- 与既有“财政预决算检查软件”后端整合（共享数据库/共享用户体系/共享审计）

---

## 3. 输入数据与表格清单（来自已提供样例）

> 一期解析必须覆盖以下 sheet（用于映射与证据定位）。  
> 备注：以下为样例 Excel 的 sheetnames（系统需按“表码”识别，而不是依赖固定顺序）。

### 3.1 单位口径（18 张）
- 2.11单位职能（单位）
- 2.12单位机构设置（单位）
- 2.13名词解释（单位）
- 2.14单位编制说明（单位）
- 2.15单位收支总表
- 2.16单位收入总表
- 2.17单位支出总表
- 2.18单位财政拨款收支总表
- 2.19单位财政拨款明细
- 2.20单位一般公共预算拨款表
- 2.21单位政府性基金拨款表
- 2.22单位国有资本经营预算拨款表
- 2.23单位一般公共预算拨款基本支出明细表
- 2.24单位项目明细
- 2.25单位“三公”经费和机关运行费预算表
- 2.26其他相关情况说明（单位）
- 2.27单位收入总表（含转移支付）
- 2.28单位支出总表（含转移支付）

### 3.2 部门口径（21 张）
- 公开表封面
- 部门公开目录
- 3.11部门主要职能（部门）
- 3.12部门机构设置（部门）
- 3.13名词解释（部门）
- 3.14部门编制说明（部门）
- 3.15部门收支总表
- 3.16部门收入总表
- 3.17部门支出总表
- 3.18部门支出分单位明细表
- 3.19部门财政拨款收支总表
- 3.20部门财政拨款支出预算明细表
- 3.21部门一般公共预算支出功能分类预算表
- 3.22部门政府性基金预算支出功能分类预算表
- 3.23部门国有资本经营预算支出功能分类预算表
- 3.24部门一般公共预算基本支出部门预算经济分类预算表
- 3.25部门“三公”经费和机关运行经费预算表
- 3.26其他相关情况说明（部门）
- 3.27项目经费情况说明（部门）
- 3.28部门收入总表（含转移支付）
- 3.29部门支出总表（含转移支付）

---

## 4. 用户角色与权限（区财政统一推进）

### 4.1 角色
- **区财政管理员**：组织目录、模板规则、历史归档锁定、纠错建议“入库审核”、全局审计。
- **内部维护人员**（你们公司工作人员）：导入历史决算归档、维护基础信息库、协助模板映射、处理工单。
- **单位/部门填报人**：上传 Excel、补录缺失字段、填写原因、校验、生成报告。
- **只读查看者**（可选）：仅查看历史版本报告与校验结果（不改数据）。

### 4.2 “上年决算纠错建议”权限（已确认）
- 单位/部门：可提交建议值并用于本次报告生成；建议需填写原因，允许上传佐证附件（可选但推荐）。
- 管理端：仅审核“是否写入历史归档（入库生效）”，不影响本次报告生成与导出。

---

## 5. 端到端业务流程

### 5.1 填报端（单位/部门）——一页式工作台（原型冻结）
1) 上传 Excel（单文件）
2) 系统识别：年度、口径（单位/部门）、单位名称/编码、模板版本
3) 自动带出：
   - 基础信息（主要职能/机构设置/名词解释）：默认沿用上年版本
   - 上年执行数/决算数：从“历史决算归档库”拉取（如 2024 预算引用 2023 决算）
4) 用户补录：
   - 平台缺失字段（采购、绩效、资产等）
   - “财政拨款支出主要内容”逐条原因（支持搜索/过滤/缺失计数/整节预览）
   - 必要时对“上年执行数”提交纠错建议（B 模式：建议值用于本次报告，入库需后台审核）
5) 点击“校验”：生成问题清单（Fatal/Warning/Suggest），定位到 sheet/cell/锚点
6) Fatal=0 → 允许生成 PDF/导出填充后 Excel；否则禁止生成

### 5.2 管理端（后台维护）——部门树 + 单位列表（已选 A）
**核心目标：在 60+ 部门、300+ 单位规模下高效维护与定位。**

- 左侧：部门树（可折叠、可搜索、展示单位数与待办数）
- 中间：单位列表（分页/虚拟滚动），每行展示状态徽标：
  - 历史归档：缺失/已入库/已锁定
  - 纠错建议：待审数量
  - 基础信息：缺失/已同步/有变更待审（若启用审批）
  - 报告：未校验/有 Fatal/已生成（可选）
- 右侧：单位详情（编辑/对比/审核/导入记录/日志）

---

## 6. 关键交互与体验细节（避免“看不方便”）

### 6.1 部门树（60+）
- 默认折叠：仅展开当前部门
- 支持搜索：输入“民政/卫健/教育”等快速过滤树节点
- 节点徽标：`单位总数 / 待办数（缺归档 + 待审纠错 + 缺基础信息）`

### 6.2 单位列表（300+）
- 服务端分页 + 前端虚拟列表（避免一次渲染 300 条以上的卡顿）
- 搜索字段：单位名称、单位代码、（可选）拼音/简称
- 快速筛选 Chips（强烈建议一期就做）：
  - 仅看“缺历史归档”
  - 仅看“有待审纠错建议”
  - 仅看“基础信息缺失”
  - 最近 7 天有修改
- 批量操作（一期可做最小版）：
  - 批量导出（基础信息/归档状态/待办）
  - 批量锁定历史归档（慎用，建议按年度/批次）

### 6.3 逐条列示（条目很多的展示方式）
- 不做“隐藏条目”作为默认策略，避免理解困难
- 默认视图：仅显示“需写原因”的条目
- 提供切换：全部 / 仅需原因 / 仅缺失原因
- 每条支持“预览句子”，右侧提供“整节预览”便于通读

---

## 7. 规则与校验（一期预算）

### 7.1 容差
- 所有金额勾稽校验容差：**0.01 万元**

### 7.2 Fatal（禁止生成）示例
- 收支总表：收入总计 ≠ 支出总计（超过容差）
- 财政拨款收支总表：拨款收入/支出不平衡（超过容差）
- 必填原因缺失（按配置：变动阈值、0→非0 等）
- 模板必填占位符缺值（例如某些表要求必须填报但未提供）

### 7.3 Warning / Suggest 示例
- 数字与说明文本不一致（轻微差异或建议补充）
- 可选字段未填（采购/绩效/资产等）但不影响生成（由财政配置）
- 版式一致性提示（分页/行数溢出将导致换页异常，需要用户确认）

### 7.4 重算（一期支持“建议重算”口子）
- 对应合计/小计存在明显不一致时，提供“重算”选项：
  - 方式 A：仅在系统内重算用于校验/报告（不回写源表）
  - 方式 B：生成“填充后 Excel”时回写合计（形成可追溯输出文件）
- 默认：方式 A（更稳，避免改原始底稿）

---

## 8. 模板与像素级一致（PDF/Excel）

### 8.1 模板维护
- 模板由内部人员维护（上海统一模板），系统支持版本化：
  - template_version：2026_v1 / 2026_v2 …
  - 占位符映射：placeholder_id → (table_code, row_key, col_key, format_rule)
- 模板变更必须触发回归测试（见第 12 章）

### 8.2 PDF 渲染建议（工程实现）
- 为保证像素级一致，推荐：
  - HTML/CSS 模板 + 嵌入字体（宋体/仿宋等） + headless print-to-pdf
  - 或 DOCX 模板 + 服务器渲染（需验证字体、分页一致性）
- 一期必须实现：**同一模板版本、同一输入 Excel → PDF 输出稳定一致**（用于验收）

---

## 9. 数据库与数据资产（为后续分析系统铺路）

### 9.1 核心原则
- 上传原件、解析证据、事实数据、校验结果、报告版本都要入库
- 任何报告数字必须可追溯：**upload → parsed_cells → facts → report_version**

### 9.2 关键表（建议 Postgres）
- org_department（部门）
- org_unit（单位）
- users / roles / permissions
- base_info_version（主要职能/机构/名词解释：版本化）
- history_actuals（历史决算归档：上年执行数来源，按 year+stage=FINAL）
- upload_job（上传记录：file_hash、来源、解析状态）
- parsed_cells（证据链：sheet、cell、value、format、anchor）
- facts_budget（预算事实表：按模板所需字段规范化）
- manual_inputs（采购/绩效/资产等人工补录）
- line_items_reason（逐条列示原因：支持多条、排序、可审计）
- validation_issues（校验问题：level、rule_id、evidence）
- report_draft（草稿：用于编辑与校验）
- report_version（版本：生成时冻结快照，绑定 PDF/Excel 文件）
- correction_suggestion（纠错建议：建议值用于本次报告；审核后可更新 history_actuals）
- audit_log（审计日志：关键动作）

### 9.3 “纠错建议（B）”的数据一致性策略（已定）
- report_version 生成时冻结：
  - 使用值 = 草稿值（可能包含建议值）
  - 同时记录 provenance：来源为 archive 或 suggestion（pending/approved/rejected）
- 管理端审核通过后：
  - history_actuals 更新为建议值（入库生效）
  - 不回溯修改已生成 report_version（保持历史可追溯）

---

## 10. API（后端开发建议）

> 要求：所有查询/写入均走服务端白名单映射，避免动态拼表/SQL 拼接。

### 10.1 填报端
- POST /api/uploads (multipart) → upload_job
- POST /api/uploads/{id}/parse → parsed_cells + facts_budget + report_draft
- GET /api/drafts/{id} → draft + base_info + history_actuals
- PATCH /api/drafts/{id}/manual-inputs
- PATCH /api/drafts/{id}/line-items
- POST /api/drafts/{id}/validate → validation_issues
- POST /api/drafts/{id}/generate → report_version + pdf/excel files（Fatal>0 则 400）

### 10.2 管理端（部门树 + 单位列表）
- GET /api/admin/departments?year=YYYY → 部门树（含聚合统计）
- GET /api/admin/units?department_id=…&q=…&filter=…&page=… → 单位列表（含状态徽标）
- GET /api/admin/units/{unit_id} → 单位详情（基础信息、历史归档、待审建议、日志）

### 10.3 历史归档与纠错建议（B）
- POST /api/admin/history/import (excel/pdf) → history_actuals（一期推荐 Excel）
- POST /api/admin/history/{id}/lock → 锁定
- POST /api/drafts/{draft_id}/suggestions → 提交纠错建议（用于本次草稿值）
- GET  /api/admin/suggestions?status=pending&year=2023&dept=… → 待审列表
- POST /api/admin/suggestions/{id}/approve → 写入 history_actuals（入库生效）
- POST /api/admin/suggestions/{id}/reject → 不入库（保留审计）

---

## 11. 原型冻结（V1 信息架构）

### 11.1 前台（填报端）单页工作台
- 上传区平台 Excel（单文件）
- 基础信息（沿用上年，可编辑：仅本次覆盖 / 提交更新单位库）
- 补录区块（采购/绩效/资产）
- 逐条列示（原因填报：搜索/过滤/缺失计数/整节预览）
- 右侧：校验结果（常驻） + 预览（常驻）
- 按钮：校验 / 生成 PDF / 导出填充后 Excel（Fatal gating）

### 11.2 后台（维护端）部门树 + 单位列表 + 详情页
- 顶部：年度选择、数据域切换（基础信息 / 历史归档 / 模板规则 / 待审建议）
- 左：部门树
- 中：单位列表（状态徽标）
- 右：详情（编辑/对比/导入/审核/日志）

---

## 12. 测试与验收标准（避免“对话太长后沟通不畅”）

### 12.1 一期验收（DoD）
- 能上传样例 Excel 并完成解析入库（单位口径+部门口径）
- 能在工作台完成补录与原因填写
- 校验输出：存在 Fatal 时禁止生成；容差 0.01 万元生效
- PDF 输出符合模板版式要求（像素级一致性通过抽样比对）
- 填充后 Excel 导出可用
- 纠错建议（B）：
  - 单位提交建议值 → 草稿/报告可用
  - 管理端审核通过后更新历史归档（入库生效）
  - 审计日志完整

### 12.2 自动化测试建议（必须写入 CI）
- 解析单测：对固定样例 Excel，校验抽取字段（含 sheet/anchor/cell 证据）
- 规则单测：勾稽关系、容差边界（0.009/0.011 万元）
- 权限测试：单位不可操作模板/历史锁定；管理员不可绕过 Fatal 强行生成（除非配置）
- 回归测试（黄金样）：同输入同模板 → PDF hash/像素 diff 通过
- 性能测试：部门树与单位列表（300 单位）在 1s 级可响应（分页/缓存）

---

## 13. CODEX 开发任务包（建议按 PR 切分）

> 每个 PR 的 Codex Prompt 要求：  
> - 明确“继续原任务对话”还是“开新任务”（默认：**继续原任务对话**）。  
> - 输出：变更文件清单、关键实现说明、可运行的本地验收命令、测试用例新增。  
> - 禁止：动态 SQL 拼接；所有字段映射必须白名单；失败必须返回明确错误码与信息。

### PR-01 数据库 Schema 与迁移
- 建表：org_department/org_unit/users/roles/base_info_version/history_actuals/upload_job/parsed_cells/facts_budget/report_draft/report_version/validation_issues/manual_inputs/line_items_reason/correction_suggestion/audit_log
- 索引：year、unit_id、department_id、file_hash、status
- 迁移脚本：支持 Postgres（一期）

### PR-02 Excel 解析器（单位/部门）
- 支持识别表码（2.xx / 3.xx）与 sheetnames
- 输出 parsed_cells（含 anchor）与 facts_budget（按映射表抽字段）
- 生成 upload_job + draft

### PR-03 校验引擎（规则体系）
- 表内/表间勾稽校验（容差 0.01 万元）
- Fatal/Warning/Suggest 分级
- evidence 定位（sheet/cell/anchor）

### PR-04 草稿编辑与逐条列示（原因）
- line_items_reason CRUD（批量更新）
- 原因必填规则（可配置阈值）
- 整节预览文本生成（仅示例/可替换）

### PR-05 模板/规则后台（最小可用）
- 模板版本、占位符映射、Fatal 配置、阈值配置
- 权限控制与审计日志

### PR-06 历史决算归档（上年执行数来源）+ 锁定
- 导入 Excel（一期优先）
- 锁定与导入批次管理
- 提供填报端自动取数 API

### PR-07 纠错建议（B）入库审核
- 填报端提交 suggestion（用于本次草稿值）
- 管理端队列：按部门树聚合 + 待审列表
- approve → 更新 history_actuals；reject → 保留记录
- report_version provenance 记录（archive/suggestion）

### PR-08 PDF/Excel 导出
- PDF 像素级模板渲染方案落地（含字体管理）
- 导出填充后 Excel（带版本水印/哈希/生成时间）
- 黄金样回归测试（像素 diff 或 hash）

### PR-09 二期预留口子（不实现决算逻辑）
- 数据模型预留：stage=FINAL、决算表码、预算-决算对比字段
- API 预留：/final/*

---

## 14. 已确认的关键决策（冻结）
- 一期做预算；二期做决算（预留口子）
- 同时支持单位口径、部门口径
- UI：一页式工作台 + 右侧校验/预览；后台：部门树 + 单位列表
- 平台缺失字段需人工填（采购/绩效/资产等）
- 输出：PDF + Excel
- 模板像素级一致；模板由内部维护
- 容差：0.01 万元
- Fatal 禁止生成
- 纠错建议：B 模式；管理员仅审核“入库（更新历史归档）”，不审核“本次报告是否可用”
