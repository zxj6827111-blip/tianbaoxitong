# 预决算公开报告自动生成与校验系统（SaaS）
**需求开发清单（PRD/开发基线 v1.0）**  
适用范围：上海市统一模板（区级/市级）；一期预算、二期决算；单位口径与部门口径同时支持。  
关键策略：**存在 Fatal ⇒ 禁止生成**；金额容差：**0.01 万元**；允许**重算**；输出 **PDF（主）+ Excel（留档）**；像素级版式一致。

---

## 0. 背景与目标

### 0.1 背景
区财政统一推进预算公开。各单位/部门从“区预决算一体化平台”导出 Excel 源表，在制作公开报告时常出现：
- 上下数据不对称、表内/表间勾稽错误；
- 表文金额与表格不一致；
- 政府采购、绩效、资产等信息平台无法导出，必须人工补充；
- 发布后复核成本高、返工频繁。

### 0.2 一句话目标
单位/部门上传平台导出的**单个 Excel**后，系统自动完成  
**识别 → 解析 →（可选）重算 → 强校验（Fatal 阻断）→ 引导补录 → 按上海统一样张模板像素级生成 PDF**，并将关键字段入库形成可审计证据链，为后续数据分析系统奠基。

### 0.3 已确认约束（红线）
1) 一期只做预算；二期做决算，但一期要预留 stage 口子。  
2) 单位口径、部门口径同时支持。  
3) SaaS：区财政统一推进（需考虑账号/链接两种使用模式）。  
4) 数据来源：上传单个 Excel（不做 zip）。  
5) 采购/绩效/资产台账等平台拿不到：系统补录。  
6) 输出：PDF（主）+ 可导出 Excel。  
7) 版式：与《2026 样张》像素级一致（字体/字号/换行/分页一致）。  
8) 存在 Fatal：禁止生成。  
9) 容差：0.01 万元。  
10) 可重算（合计按明细重算）。  
11) 模板由内部维护（上海市统一模板；区/市替换可配置）。  
12) 往年数据可先入库，文字说明可复用。  
13) SaaS 部署在公司自有服务器。  
14) 暂不打通检查系统，但预留接口；数据库共享并沉淀数据用于分析系统。

---

## 1. 阶段规划与范围

### 1.1 一期（预算）范围
- stage：预算（Budget）
- scope：单位 / 部门
- 输入：单个 Excel
- 输出：PDF + 填充后 Excel
- 校验：Fatal 阻断；容差 0.01 万元；允许重算并记录证据链
- 补录：采购/绩效/资产等
- 数据：必须入库（raw_upload/parsed_cells/facts_budget/manual_inputs/report_version/outputs/validation_issues/audit_log）

### 1.2 二期（决算）范围
- stage：决算（Final）
- 决算规则包 + 决算模板包
- 预算—决算对比分析（建议作为二期核心卖点）
- 财政端批量队列、渲染节点池、失败重试
- 证据链增强（截图高亮，可选）
- 与检查系统接口联动（可选）

---

## 2. 角色、权限与使用模式

### 2.1 角色
- 区财政管理员：单位/账号管理、模板发布、全区查看、批量任务（一期可简化、二期增强）
- 单位经办人：上传、补录、修复、生成、下载
- 单位审核人：审核并确认提交（一期可先做“内部确认”状态）
- 系统管理员/运维：渲染节点池、队列、对象存储、监控告警

### 2.2 使用模式（推荐）
- **模式 A（默认）：单位账号体系**  
  财政创建单位并分配账号；单位登录后仅访问本单位数据。
- **模式 B（辅助）：一次性限时链接**  
  财政生成绑定单位+有效期链接，免登录上传生成；必须完整审计、严格隔离。
- 不建议匿名开放真实数据；如需“像百度一样”入口，仅提供脱敏 demo。

### 2.3 权限隔离（必须）
- 单位 A 不得访问单位 B 的任何数据、文件、产物；
- 管理后台仅内部人员可访问；
- 关键操作必须写审计日志。

---

## 3. 核心业务流程与状态机

### 3.1 一期流程
上传 Excel → 自动识别（stage/scope/year/unit_name） → 解析（锚点识别） →（可选）重算  
→ 校验（Fatal/Warning/Suggest） → 补录（采购/绩效/资产等） → 再校验（Fatal=0）  
→ 模板填充 → 导出 PDF（像素级一致）+ 导出填充后 Excel → 入库 + 历史版本可查可下载

### 3.2 状态机
- DRAFT：上传完成/解析完成
- INVALID：存在 Fatal（禁止生成）
- NEED_MANUAL：缺失补录项
- READY：校验通过（Fatal=0，必填补录齐）
- RENDERING：渲染中
- DONE：生成成功
- FAILED：生成失败（可重试，记录原因）

---

## 4. 数据资产与数据库模型（一期必须落地）

> 原则：对外输出必须可追溯；禁止从 raw/Excel 临时值“口算”对外输出。

### 4.1 表/实体清单（最小可用）
1) unit：单位/部门主数据（名称、编码、层级、状态等）  
2) raw_upload：上传文件元信息（对象存储 URL、SHA256、文件名、上传人、时间）  
3) report_version：版本主表（unit_id、year、stage、scope、template_version、ruleset_version、status）  
4) parsed_cells：证据单元（sheet、锚点、A1 坐标、原始值、标准化值、单位、备注）  
5) facts_budget：预算事实表（按字段字典落库；金额以“元”存储）  
6) manual_inputs：补录字段（采购/绩效/资产/原因文本等；可复用）  
7) validation_issues：校验结果（rule_id、level、message、diff、tolerance、evidence_ref）  
8) outputs：产物（pdf_url、excel_url、hash、渲染节点、时间）  
9) audit_log：审计日志（actor、action、before/after、time、ip 等）

### 4.2 金额与单位规则
- 数据库存储统一使用“元”（整数/高精度），避免浮点误差；
- 展示层按模板换算为“万元”并保留 2 位；
- 表文一致性与万元口径校验采用容差 **0.01 万元**；
- 换算/四舍五入规则写入字段字典并可测试。

### 4.3 版本与追溯
- 每次生成必须创建 report_version；
- 每条问题必须能追溯到 parsed_cells（sheet/锚点/A1 坐标）；
- 产物 PDF/Excel 记录 hash 并绑定版本。

---

## 5. 字段字典与模板映射（关键能力）

### 5.1 字段字典（Data Dictionary）
字段必须定义：
- field_key（唯一键，如 income_total_yuan）
- 含义（meaning）
- 来源（source：sheet/锚点/提取逻辑）
- storage_unit（元）
- display_unit（万元/元）
- rounding（保留位数与规则）
- validation（参与哪些规则/容差）

### 5.2 模板映射（Template Mapping）
- 模板版本化：年度 × 区级/市级 × 单位/部门 × 预算/决算
- 映射粒度：
  - 单元格写入（字段 → 目标单元格）
  - 段落占位符（字段 → 文本占位符）
- 模板自检（建议一期就做）：
  - 映射覆盖率 100%
  - 文本溢出/换行/分页漂移风险预警
  - 渲染节点字体包一致性校验
- 发布机制：草稿/发布/回滚

---

## 6. 校验规则引擎（一期预算）

### 6.1 分级与处置
- FATAL：阻断生成（禁止输出 PDF/Excel）
- WARNING：允许生成但提示（可配置是否阻断）
- SUGGEST：规范性建议，不阻断

### 6.2 规则输出规范（每条规则必须输出）
- rule_id、level、pass/fail、message
- diff、tolerance（容差）
- evidence（sheet/锚点/A1 坐标，至少坐标级）
- fix_hint（修复建议）
- 规则版本 ruleset_version 必须写入 report_version

### 6.3 一期预算最少 FATAL 规则集（必须）
1) 收支总表：收入总计 = 支出总计  
2) 财政拨款收支总表：总计 = 一般公共预算 + 基金 + 国资  
3) 表内合计=分项（出现“合计”行/列即校验）  
4) 单位换算一致（元↔万元）  
5) 表文金额与表取数一致（生成后校验）  
6) 关键必填项缺失（如采购/绩效/资产补录项，按配置可设为 Fatal）

### 6.4 重算策略（必须）
- 合计缺失/公式未计算/异常：按明细汇总重算；
- 记录重算前后差异；
- 可选“回写”到解析结果/输出表（不改用户原文件）。

---

## 7. 文本生成与补录

### 7.1 自动生成原则
- 所有金额数字必须系统取数填入，不允许用户手改数字；
- 原因文本允许“原因库 + 自由补充”；
- 生成后必须跑表文一致性校验。

### 7.2 人工补录（一期必须）
- 政府采购：总额（万元）、其中中小/小微（可选）、口径说明  
- 绩效管理：文字说明（可复用往年草稿，但需确认并审计）  
- 国有资产占有使用情况：车辆、房屋面积、50 万以上设备等（按样张字段）  
- 其他模板要求的必填/无则写无字段

### 7.3 往年复用（一期 P1）
- 支持从上一年复制：职能、机构设置、名词解释、原因文本、补录草稿；
- 复制后需确认并记录审计。

---

## 8. 输出与渲染（像素级一致）

### 8.1 输出
- PDF（主输出）
- Excel（填充后的工作簿）
- 可选：发布包 zip（PDF+Excel+校验报告+元数据）

### 8.2 像素级一致（强制）
- 以官方样张为底稿，仅填值，不重排版；
- 渲染环境锁定字体/打印参数；
- 同一输入在不同时间/节点输出一致；
- 建议“金样渲染回归”（见测试章节）。

---

## 9. SaaS 非功能需求（必须）
- 安全：鉴权、隔离、对象存储防裸链、后台强权限
- 审计：上传/补录/重算/生成/下载/模板发布全量审计
- 稳定：任务队列、失败重试、失败可定位、节点健康监控
- 扩展：stage=决算，规则包/模板包可插拔；预留检查系统接口

---

## 10. 功能清单（一期/二期）

### 10.1 一期 P0（必须）
- 上传与自动识别（预算/单位/部门/年度/单位名）
- 解析与重算（锚点识别）
- Fatal 规则引擎（容差 0.01 万元）
- 补录表单 + 入库 + 审计
- 模板填充 + PDF/Excel 导出
- 历史版本与下载
- 权限隔离与审计日志

### 10.2 一期 P1（强烈建议）
- 模板维护后台（版本/映射/自检/发布/回滚）
- 往年复用与差异提示（变化最大科目提示+原因库）
- 证据链增强（问题→证据定位跳转）

### 10.3 二期 P0（必须）
- 决算全链路（识别/解析/重算/校验/补录/生成）
- 决算规则包（Fatal 阻断）
- 决算模板包维护与发布

### 10.4 二期 P1（建议）
- 预算—决算对比分析（差异表 + 原因文本，金额可追溯）
- 财政批量队列（多单位批量上传/生成、失败重试、导出清单）

### 10.5 二期 P2（可选）
- 证据链截图高亮
- 与检查系统联动接口落地
- 预决算数据分析系统（指标库、异常雷达、看板）

---

## 11. 接口预留（简版）

### 11.1 一期内部 API（建议）
- POST /api/reports/upload
- POST /api/reports/{id}/parse
- GET  /api/reports/{id}/validation
- POST /api/reports/{id}/manual-input
- POST /api/reports/{id}/render
- GET  /api/reports/{id}/outputs
- GET  /api/admin/templates
- POST /api/admin/templates
- POST /api/admin/templates/{id}/self-check
- POST /api/admin/templates/{id}/publish

### 11.2 联动预留（暂不启用）
- POST /api/integrations/checker/push
- POST /api/integrations/checker/callback

---

## 12. 测试与验收（DoD：必须通过）

### 12.1 单元测试（必须）
- 识别正确（stage/scope/year/unit_name）
- 解析与重算正确
- 规则判定正确（正确/错误样例）
- 容差边界用例覆盖（0.009/0.010/0.011 万元）

### 12.2 集成测试（必须）
- 端到端：上传→识别→解析→校验→补录→生成→下载
- 入库完整性：raw_upload/report_version/parsed_cells/facts/manual_inputs/outputs/issues 全量写入
- 权限隔离：单位 A 无法访问单位 B

### 12.3 金样与像素级回归（强烈建议）
- 每模板版本：金样输入 + 金样输出 PDF
- CI：facts 结构化对比 + PDF 像素 diff ≤ 阈值

### 12.4 安全与审计（必须）
- 下载鉴权（禁止裸链）
- 审计日志完整可查

---

## 13. CODEX 提交规范（避免长对话偏航）

### 13.1 提交策略
- 每个里程碑/模块：建议**开新任务对话**（上下文更干净）
- 同一 PR 的小修补：可在原对话继续

### 13.2 每次提交给 CODEX 的任务包必须包含
1) 目标（1–3 句）  
2) 范围（做/不做）  
3) 输入样例文件列表  
4) 输出与验收标准（Fatal 阻断、容差 0.01 万元、像素级 PDF）  
5) 数据表变更（migrations 清单）  
6) API 清单（route + request/response）  
7) 测试用例清单（对应 DoD）  
8) 禁止事项（禁止绕过 Fatal、禁止无审计写库等）

### 13.3 推荐 PR 拆分
一期：
- PR-01 Upload&Detect（上传+识别+report_version）
- PR-02 Parser&Recalc（解析+重算+parsed_cells/facts_budget）
- PR-03 RuleEngine（Fatal 阻断+证据定位+容差）
- PR-04 ManualInput（补录表单+入库+复用）
- PR-05 TemplateFill&Render（模板填充+PDF导出+产物入库）
- PR-06 AdminConsole（模板版本/映射/自检/发布）
- PR-07 RBAC&Audit（权限隔离+审计+对象存储鉴权）

二期：
- PR-08 决算 stage 全链路
- PR-09 预算—决算对比分析
- PR-10 批量队列与渲染节点池
- PR-11 证据链截图高亮/联动接口（可选）

---

## 14. 交付与验收输出物
每次交付必须附带：
- 变更日志（变更点/影响范围）
- 测试报告（单测/集成/金样）
- 数据库迁移脚本
- 回滚方案（模板回滚/服务回滚）

---

## 15. UI 信息架构（与 Demo 对齐）
- 工作台：上传/识别/进度
- 校验中心：问题列表（Fatal/Warning/Suggest）+ 证据定位 + 重算
- 补录：采购/绩效/资产/原因库
- 生成与下载：PDF/Excel/发布包
- 历史版本：版本号、状态、规则/模板版本、审计
- 管理后台：模板版本、字段映射、模板自检、发布/回滚、单位与账号管理

---

**注**：本文件为“开发基线 v1.0”。后续扩展省份/模板，只新增规则包与模板包，不改变证据链与数据资产结构。
